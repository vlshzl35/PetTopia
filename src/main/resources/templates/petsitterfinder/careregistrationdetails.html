<!DOCTYPE html>
<html layout:decorate="~{layout/default}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title>ì£¼ì†Œ ê²€ìƒ‰ ë° ì˜ˆì•½ ì •ë³´</title>
    <!-- Bootstrap CSS ì¶”ê°€ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .page-body {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            align-items: flex-start;
            width: 80%;
            height: 1500px;
            margin: 10px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .reservation-details {
            width: 45%;
            background: #d4edda;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            line-height: 1.6;
        }

        .petProfile {
            width: 30%;
            height: 30%;
            text-align: center;
        }

        .petProfile img {
            width: 100%;
            height: 50%;
            border-radius: 90px;
        }

        .map-spot {
            position: absolute;
            width: 40%;
            text-align: center;
            bottom: 20px;
            right: 20px;
        }

        .map-spot #map {
            width: 100%;
            height: 350px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .comment-section {
            width: 55%;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
            height: 750px;
        }

        .comment {
            padding: 15px;
            margin-bottom: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .comment .comment-meta {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .comment .comment-content {
            font-size: 1rem;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ì„ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì • */
        .navbar, .navbar-nav, .nav-link, .navbar-brand {
            background-color: #ffffff !important;
            color: #000000 !important;
        }

        .nav-link {
            color: #000000 !important;
        }

        .navbar-brand {
            color: #000000 !important;
        }

        .navbar .nav-link:hover {
            color: #28a745 !important; /* ì˜ˆì‹œë¡œ ë…¹ìƒ‰ìœ¼ë¡œ ì„¤ì • */
        }


    </style>
</head>
<body>

<div class="page-body" layout:fragment="main">
    <!-- ì˜ˆì•½ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
    <section class="reservation-details">
        <input type="hidden" id="addressInput" th:value="${detail.address}">
        <h2><strong>ğŸ¶ìš°ë¦¬ ê°•ì•„ì§€ë¥¼ ëŒë´ì£¼ì„¸ìš”ğŸ¶</strong></h2>
        <p>ì´ë¦„: <span th:text="${detail.petName}" ></span></p>
        <p>ê°•ì•„ì§€ ì„±ê²©: <span th:text="${detail.petSociability}"></span></p>
        <p>ê°•ì•„ì§€ ì¶œìƒì¼: <span th:text="${detail.petBirth}"></span></p>
        <p>ê²¬ì¢…: <span th:text="${detail.petBreed}"></span></p>
        <p>ê°•ì•„ì§€ í¬ê¸°: <span th:text="${detail.petSize.petSize}"></span></p>
        <p>ì˜ˆë°© ì ‘ì¢…: <span th:text="${detail.petVaccinationTypeNames}"></span></p>
        <p>ê¸°ìƒì¶© ì˜ˆë°© ì ‘ì¢…: <span th:text="${detail.petParasitePreventionNames}"></span></p>
        <p>ì˜ˆì•½ ìš”ì²­ ë‚ ì§œ: <input type="date" th:value="${detail.startDate}" readonly></p>
        <p>ì˜ˆì•½ ì¢…ë£Œìš”ì²­ ë‚ ì§œ: <input type="date" th:value="${detail.endDate}" readonly></p>
        <p>ì˜ˆì•½ ì„œë¹„ìŠ¤: <span th:text="${detail.requestService}"></span></p>
        <p>ì¶”ê°€ì ì¸ ìš”ì²­ì‚¬í•­: <span th:text="${detail.additionalInfo}"></span></p>
        <div class="update-box">
            <button class="btn btn-primary" th:if="${isWriter}" th:onclick="|location.href = '@{/petsitterfinder/detailupdate(postId=${detail.postId})}'|">ìˆ˜ì •/ì‚­ì œ</button>
            <input type="hidden" name ="sitterStatus" id ="sitterStatus" th:value="${memberInfo.sitterStatus}">
            <button name= "requestBtn" id="requestBtn" class="btn btn-primary">ì˜ˆì•½ìš”ì²­</button>
            <button class="btn btn-primary" th:if="${isWriter}" th:onclick="|location.href = '@{/petsitterfinder/reservation(postId=${detail.postId})}'|">ì˜ˆì•½ ëª©ë¡ ë³´ê¸°</button>
        </div>
    </section>

    <!-- í« í”„ë¡œí•„ ì˜ì—­ -->
    <section class="petProfile">
        <h2>â˜ºï¸ìš°ë¦¬ ê°•ì•„ì§€ì—ìš”â˜ºï¸</h2>
        <img th:src="${detail.profile}" alt="ê°•ì•„ì§€ ì‚¬ì§„" >
    </section>

    <!-- ì§€ë„ í‘œì‹œ ì˜ì—­ -->
    <section class="map-spot">
        <h2>ğŸ ì´ ê·¼ì²˜ì— ì‚´ì•„ìš”ğŸ </h2>
        <div id="map"></div>
    </section>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    <section class="comment-section">
        <h3>ëŒ“ê¸€ ì‘ì„±</h3>
        <div class="mb-3">
            <textarea class="form-control" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." id="commentContents" name="commentContents"></textarea>
        </div>
        <input type="hidden" name="commentWriter" id="commentWriter" th:value="${memberInfo.name}">
        <input type="hidden" name="memberId" id="memberId" th:value="${memberInfo.id}">
        <input type="hidden" name="memberEmail" id="memberEmail" th:value="${memberInfo.email}">

        <button id="comment-write-btn" class="btn btn-success w-100" onclick="commentWrite()">ëŒ“ê¸€ ì‘ì„±</button>
        <div id="comment-list" class="mt-4">
            <!-- ì—¬ê¸°ì— ëŒ“ê¸€ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
        </div>
        <nav class="position-absolute" aria-label="Page navigation example" style="bottom: 0; left: 120px; width: 400px" >
            <ul class="pagination justify-content-center">
                <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë§í¬ëŠ” JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </ul>
        </nav>
    </section>

    <script>
        // í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ì €ì¥
        let currentPage = 1;

        // ëŒ“ê¸€ ëª©ë¡ì„ íŠ¹ì • í˜ì´ì§€('page')ì—ì„œ ì„œë²„ë¡œë¶€í„° ê°€ì ¸ì™€ì„œ í˜ì´ì§€ì— í‘œì‹œ (ì´í•´ì•ˆë¨)
        const loadComments = (page = 1) => {
            const postId = [[${detail.postId}]];
            $.ajax({
                type: "get",
                // ì„œë²„ì˜ ëŒ“ê¸€ ëª©ë¡ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ postIdì™€ pageë¥¼ í¬í•¨í•œ URLë¡œ ìš”ì²­í•¨
                url: `/comment/list?postId=${postId}&page=`+page,
                success: function(res) {
                    console.log("ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ ì„±ê³µ", res);
                    let output = "";
                    // listê°€ ì•„ë‹Œ Pageë¡œ ê°ì²´ë¥¼ ë°˜í™˜í–ˆì„ ë•Œ forEach ë°”ë¡œ ì‚¬ìš© ëª»í•¨
                    // res.forEach -> res.content.forEachë¡œ ìˆ˜ì •í•¨
                    res.content.forEach(comment => {
                        output += `
                            <div class="comment">
                                <div class="comment-meta">
                                    <strong>${comment.commentWriter}</strong> Â· ${comment.commentCreatedTime}
                                </div>
                                <div class="comment-content">
                                    ${comment.commentContents}
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('comment-list').innerHTML = output;
                    // ëŒ“ê¸€ ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•œ í›„ , í˜ì´ì§€ë„¤ì´ì…˜ë„ ì—…ë°ì´íŠ¸
                    updatePagination(res);
                },
                error: function(err) {
                    console.log("ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", err);
                }
            });
        };
        //(pageData ì´í•´ ì•ˆë¨ = () => {} ì´ëŸ° í˜•ì‹ë„ ì´í•´ì•ˆë¨ ì†”ì§íˆ)
        // pageData ëŠ” Page<CommentDTO>ê°ì²´ì„, í˜•ì¬ í˜ì´ì§€, ì´ í˜ì´ì§€ ìˆ˜ ë“±ì˜ ì •ë³´ë¥¼ ë‹´ê³  ìˆìŒ
        const updatePagination = (pageData) => {
            let paginationHtml = '';
            for (let i = 1; i <= pageData.totalPages; i++) {
                console.log("ì´ê±´ ë˜ ë¬´ì–¼ê¹Œë‚˜ ã…ã…" + pageData.totalPages)
                console.log("ì´ê±´ ë˜ ë¬´ì–¼ê¹Œë‚˜ ã…ã…" + pageData.number) //
                paginationHtml += `<li class="page-item ${i === pageData.number + 1 ? 'active' : ''}">
                               <a class="page-link" href="javascript:void(0);" onclick="loadComments(${i})">${i}</a>
                           </li>`;
                console.log("ì´ê±°ëª¨ì„?"+paginationHtml)
            }
            // .paginationì€ paginationHtml ë°›ì•„ì„œ ê¸°ë³¸ì ì¸ í˜ì´ì§€ë„¤ì´ì…˜ êµ¬ì¡° ì œê³µí•´ì¤Œ
            // class="pagination" ì„ ê°€ì§„ ulìš”ì†Œë¥¼ ì„ íƒí•¨
            document.querySelector('.pagination').innerHTML = paginationHtml;
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ëª©ë¡ì„ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', () => loadComments(currentPage));

        // ëŒ“ê¸€ ì‘ì„± í•¨ìˆ˜
        const commentWrite = () => {
            const contents = document.getElementById("commentContents").value;
            const writer = document.getElementById("commentWriter").value;
            const memberId = document.getElementById("memberId").value;
            const postId = [[${detail.postId}]];
            $.ajax({
                type: "post",
                url: "/comment/save",
                data: {
                    "commentContents": contents,
                    "commentWriter": writer,
                    "memberId": memberId,
                    "postId": postId
                },
                success: function(res) {
                    console.log("ìš”ì²­ ì„±ê³µ", res);
                    loadComments(); // ëŒ“ê¸€ ì‘ì„± í›„ ëŒ“ê¸€ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
                    document.getElementById('commentContents').value = '';
                },
                error: function(err) {
                    console.log("ìš”ì²­ ì‹¤íŒ¨", err);
                }
            });
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ëª©ë¡ì„ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', loadComments);
    </script>

    <!-- Bootstrap JS ë° ì˜ì¡´ì„± ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ì¹´ì¹´ì˜¤ ë§µ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c2c4e06dc64e84c36fa8af04a0f00306&libraries=services"></script>
    <script>
        var mapContainer = document.getElementById('map'),
            mapOption = {
                center: new kakao.maps.LatLng(33.450701, 126.570667),
                level: 2
            };

        var map = new kakao.maps.Map(mapContainer, mapOption);
        var geocoder = new kakao.maps.services.Geocoder();
        var marker = new kakao.maps.Marker({ map: map });
        var infowindow = new kakao.maps.InfoWindow();

        function searchAddress() {
            var address = document.getElementById('addressInput').value;

            geocoder.addressSearch(address, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                    marker.setPosition(coords);
                    infowindow.setContent('<div style="width:150px;text-align:center;padding:6px 0;">' + address + '</div>');
                    infowindow.open(map, marker);
                    map.setCenter(coords);
                } else {
                    infowindow.close();
                    marker.setMap(null);
                }
                var circle = new kakao.maps.Circle({
                    center: new kakao.maps.LatLng(result[0].y, result[0].x),
                    radius: 30,
                    strokeWeight: 5,
                    strokeColor: '#75B8FA',
                    strokeOpacity: 1,
                    strokeStyle: 'dashed',
                    fillColor: '#CFE7FF',
                    fillOpacity: 0.4
                });
                circle.setMap(map);
            });
        }

        document.addEventListener('DOMContentLoaded', searchAddress);
    </script>

<!--    sitterStatusê°€ approvedë˜ì§€ ì•Šì€ íšŒì›ì€ ì˜ˆì•½ ìš”ì²­ ê±°ì ˆë¨. -->
    <script>
        const status = document.getElementById('sitterStatus').value;

        document.getElementById('requestBtn').addEventListener('click', function (){
            const sitterStatus = status
            console.log(sitterStatus)

            if(sitterStatus !== 'APPROVED'){
                alert('í«ì‹œí„° ê¶Œí•œì´ ì—†ëŠ” íšŒì›ì€ ì˜ˆì•½ ìš”ì²­í•˜ì‹¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
            }else {

                const confirmation =  confirm('ì˜ˆì•½ì„ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')
                if(confirmation){
                // ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì¿¼ë¦¬íŒŒë¼ë¯¸í„° ìš”ì²­
                const postId = [[${detail.postId}]];
                const memberEmail = '[[${memberInfo.email}]]' // ë¬¸ìì—´ ë°›ì„ ë•Œì—ëŠ” ë”°ì˜´í‘œ ë¬´ì¡°ê±´ ê°ì‹¸ì¤˜ì•¼í•¨ ì•ˆê°ì‹¸ì¤˜ì„œ ê³„ì† ì˜¤ë¥˜ë‚¬ì—ˆë„¤ ì´ëŸ°!!

                    $.ajax({
                        type: "post",
                        url: "/petsitterfinder/reservation",
                        data:{
                            "memberEmail":memberEmail,
                            "postId":postId
                        },
                        success: function(res) {
                            console.log("ìš”ì²­ ì„±ê³µ", res);
                            alert("ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.")
                            window.location.href = `/petsitterfinder/careregistrationdetails?postId=${postId}`
                        },
                        error: function(err) {
                            console.log("ìš”ì²­ ì‹¤íŒ¨", err.responseText);
                            alert('ì—ëŸ¬ ë°œìƒ:' +err.responseText)
                        }
                    })
                }

            }
        })

    </script>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>




    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <script src="/js/ring/ring.js"></script>

</div>
</body>
</html>
