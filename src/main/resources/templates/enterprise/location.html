<!doctype html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/default}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ìœ„ì¹˜ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" href="/css/kakao-map.css">
    <link href="/css/enterprise/location.css" rel="stylesheet">
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c2c4e06dc64e84c36fa8af04a0f00306&libraries=services"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div layout:fragment="main" class="page-body">
    <section class="section">
        <div class="container">
            <div class="header-container">
                <img src='/svg/map.svg' class="ocr-image">
                <h2>ì£¼ë³€ ë³‘ì› â€¢ ì•½êµ­ â€¢ ë¯¸ìš©ì‹¤ ìœ„ì¹˜ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</h2>
                <img src='/svg/receipt.svg' class="ocr-image">
            </div>
        </div>
    </section>

    <div class="container">
        <div class="info-text">
            <h5>â˜ğŸ» ë³‘ì› â€¢ ì•½êµ­ â€¢ ë¯¸ìš©ì‹¤ ì¤‘ ì›í•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!</h5>
        </div>
        <div class="info-text">
            <h5> ğŸ“ í‘œì‹œë˜ëŠ” ë§ˆì»¤ë¥¼ ëˆ„ë¥´ë©´, ë³‘ì› â€¢ ì•½êµ­ â€¢ ë¯¸ìš©ì‹¤ì˜ í›„ê¸°ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”!</h5>
        </div>
        <div class="info-text" >
            <h4>ğŸ–</h4>
            <h5>ï¸í«í† í”¼ì•„ëŠ” ì˜ìˆ˜ì¦ ì¸ì¦ì„ í†µí•œ <strong style="color: #00bd56">ì‹ ë¢°ë„ ìˆëŠ” í›„ê¸°</strong>ë§Œ ì œê³µí•´ìš”!ï¸</h5>
        </div>
        <div id="mapwrap">
            <div id="map" class="map"></div>
            <ul class="category">
                <li id="hospitalMenu" onclick="changeMarker('hospital')">
                    <span class="ico_comm ico_hospital"></span>
                    ë³‘ì›
                </li>
                <li id="pharmacyMenu" onclick="changeMarker('pharmacy')">
                    <span class="ico_comm ico_pharmacy"></span>
                    ì•½êµ­
                </li>
                <li id="hairsalonMenu" onclick="changeMarker('hairsalon')">
                    <span class="ico_comm ico_hairsalon"></span>
                    ë¯¸ìš©ì‹¤
                </li>
            </ul>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ì—¬ ë‹¤ë¥¸ í•¨ìˆ˜ì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤
        let userLat = 37.512983969113506;  // ê³ ì •ëœ ê¸°ë³¸ê°’ (ì„œìš¸ì˜ ì˜ˆì‹œ ì¢Œí‘œ)
        let userLon = 127.05305952813623;  // ê³ ì •ëœ ê¸°ë³¸ê°’ (ì„œìš¸ì˜ ì˜ˆì‹œ ì¢Œí‘œ)
        var map;

        var currentInfowindow = null; // í˜„ì¬ ì—´ë¦° ì¸í¬ìœˆë„ìš°ë¥¼ ì¶”ì í•˜ëŠ” ë³€ìˆ˜  // ì¶”ê°€ëœ ë¶€ë¶„
        var currentMarker = null; // í˜„ì¬ í´ë¦­ëœ ë§ˆì»¤ë¥¼ ì¶”ì í•˜ëŠ” ë³€ìˆ˜  // ì¶”ê°€ëœ ë¶€ë¶„

        // Geolocation APIë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤
        navigator.geolocation.getCurrentPosition(
            (position) => {
                // ìœ„ì¹˜ ì •ë³´ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì˜¨ ê²½ìš°
                userLat = position.coords.latitude;   // ìœ„ë„
                userLon = position.coords.longitude;  // ê²½ë„
                console.log("Current Position:", userLat, userLon);

                // ìœ„ì¹˜ ì •ë³´ê°€ ì„¤ì •ëœ í›„ ì‹¤í–‰í•  ì½”ë“œ
                handlePosition(userLat, userLon);
            },
            (error) => {
                // ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•œ ê²½ìš°
                console.warn(`Geolocation Error (${error.code}): ${error.message}`);

                // ê³ ì •ëœ ê°’ìœ¼ë¡œ ì§€ë„ ìƒì„±
                handlePosition(userLat, userLon);
            }
        );

        // ìœ„ì¹˜ ì •ë³´ê°€ ì„¤ì •ëœ í›„ ì‹¤í–‰í•  í•¨ìˆ˜
        function handlePosition(lat, lon) {
            console.log('í…ŒìŠ¤íŠ¸ìš©', lat);
            console.log('í…ŒìŠ¤íŠ¸ìš©', lon);
            var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div
                mapOption = {
                    center: new kakao.maps.LatLng(lat, lon), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
                    level: 5 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
                };

            map = new kakao.maps.Map(mapContainer, mapOption); // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
        }

        var hospitalMarkers = [], // ë³‘ì› ë§ˆì»¤ ê°ì²´ë¥¼ ê°€ì§€ê³  ìˆì„ ë°°ì—´ì…ë‹ˆë‹¤
            pharmacyMarkers = [], // ì•½êµ­ ë§ˆì»¤ ê°ì²´ë¥¼ ê°€ì§€ê³  ìˆì„ ë°°ì—´ì…ë‹ˆë‹¤
            hairsalonMarkers = []; // ë¯¸ìš©ì‹¤ ë§ˆì»¤ ê°ì²´ë¥¼ ê°€ì§€ê³  ìˆì„ ë°°ì—´ì…ë‹ˆë‹¤

        // JSON íŒŒì¼ ë¶ˆëŸ¬ì™€ ë§ˆì»¤ ìƒì„±
        function loadMarkers() {
            $.ajax({
                url: '/json/hospitalData.json',
                dataType: 'json',
                success: function (data) {
                    console.log('ë³‘ì› ë°ì´í„° ë¡œë“œ ì„±ê³µ:', data);
                    createMarkers(data.documents, 'hospital');
                },
                error: function (xhr, status, error) {
                    console.error('ë³‘ì› ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            });

            $.ajax({
                url: '/json/pharmacyData.json',
                dataType: 'json',
                success: function (data) {
                    console.log('ì•½êµ­ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', data);
                    createMarkers(data.documents, 'pharmacy');
                },
                error: function (xhr, status, error) {
                    console.error('ì•½êµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            });

            $.ajax({
                url: '/json/salonData.json',
                dataType: 'json',
                success: function (data) {
                    console.log('ë¯¸ìš©ì‹¤ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', data);
                    createMarkers(data.documents, 'hairsalon');
                },
                error: function (xhr, status, error) {
                    console.error('ë¯¸ìš©ì‹¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            });
        }

        // ë§ˆì»¤ë¥¼ ìƒì„±í•˜ê³  ë°°ì—´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        function createMarkers(data, type) {
            var markers = [];
            var imageSrc;
            var urlPrefix = '';

            // ì¹´í…Œê³ ë¦¬ì— ë”°ë¥¸ ì•„ì´ì½˜ê³¼ URL ì„¤ì •
            if (type === 'hospital') {
                imageSrc = 'https://cdn-icons-png.flaticon.com/128/3448/3448513.png';
                urlPrefix = '/enterprise/hospital/detail?id=';
            } else if (type === 'pharmacy') {
                imageSrc = 'https://cdn-icons-png.flaticon.com/128/4287/4287703.png';
                urlPrefix = '/enterprise/pharmacy/detail?id=';
            } else if (type === 'hairsalon') {
                imageSrc = 'https://cdn-icons-png.flaticon.com/128/14183/14183655.png';
                urlPrefix = '/enterprise/salon/detail?id=';
            }

            var imageSize = new kakao.maps.Size(34, 45),
                imageOptions = {offset: new kakao.maps.Point(12, 35)};

            $.each(data, function (index, item) {
                var position = new kakao.maps.LatLng(item.y, item.x); // ìœ„ë„, ê²½ë„ í™•ì¸ í•„ìš”
                var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOptions);
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: position,
                    image: markerImage
                });

                var content = `
		            <div style="padding:10px; width: 170px; height: 120px; background-color: #fff; border: 2px solid #FF5F4A; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);">
		                <strong style="font-size: 14px; color: #333;">${item.place_name}</strong><br>
		                <a href="${urlPrefix}${item.id}" style="color: #FF5F4A; text-decoration: none;">ìì„¸íˆ</a><br>
		            </div>`;

                var infowindow = createInfoWindow(content);

                kakao.maps.event.addListener(marker, 'click', function() {
                    // ë™ì¼í•œ ë§ˆì»¤ê°€ í´ë¦­ë˜ì—ˆì„ ë•Œ ì¸í¬ìœˆë„ìš°ë¥¼ ë‹«ìŒ  // ì¶”ê°€ëœ ë¶€ë¶„
                    if (currentInfowindow && currentMarker === marker) {
                        currentInfowindow.close();
                        currentInfowindow = null;
                        currentMarker = null;
                    } else {
                        // ë‹¤ë¥¸ ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ, ì´ì „ ì¸í¬ìœˆë„ìš°ê°€ ì—´ë ¤ ìˆë‹¤ë©´ ë‹«ìŒ
                        if (currentInfowindow) {
                            currentInfowindow.close();
                        }
                        // ìƒˆ ì¸í¬ìœˆë„ìš°ë¥¼ ì—´ê³ , í˜„ì¬ ì—´ë¦° ì¸í¬ìœˆë„ìš°ë¡œ ì„¤ì •
                        infowindow.open(map, marker);
                        currentInfowindow = infowindow;
                        currentMarker = marker;  // ì¶”ê°€ëœ ë¶€ë¶„
                    }
                });

                markers.push({marker: marker, infowindow: infowindow});
            });

            if (type === 'hospital') {
                hospitalMarkers = markers;
                setHospitalMarkers(null);
            } else if (type === 'pharmacy') {
                pharmacyMarkers = markers;
                setPharmacyMarkers(null);
            } else if (type === 'hairsalon') {
                hairsalonMarkers = markers;
                setHairsalonMarkers(null);
            }
        }

        // ì¸í¬ìœˆë„ìš° ìƒì„± í•¨ìˆ˜
        function createInfoWindow(content) {
            var infowindow = new kakao.maps.InfoWindow({
                content: content
            });
            return infowindow;
        }

        // ë³‘ì› ë§ˆì»¤ë“¤ì˜ ì§€ë„ í‘œì‹œ ì—¬ë¶€ë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
        function setHospitalMarkers(map) {
            for (var i = 0; i < hospitalMarkers.length; i++) {
                hospitalMarkers[i].marker.setMap(map);
            }
        }

        // ì•½êµ­ ë§ˆì»¤ë“¤ì˜ ì§€ë„ í‘œì‹œ ì—¬ë¶€ë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
        function setPharmacyMarkers(map) {
            for (var i = 0; i < pharmacyMarkers.length; i++) {
                pharmacyMarkers[i].marker.setMap(map);
            }
        }

        // ë¯¸ìš©ì‹¤ ë§ˆì»¤ë“¤ì˜ ì§€ë„ í‘œì‹œ ì—¬ë¶€ë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
        function setHairsalonMarkers(map) {
            for (var i = 0; i < hairsalonMarkers.length; i++) {
                hairsalonMarkers[i].marker.setMap(map);
            }
        }

        // ì¹´í…Œê³ ë¦¬ë¥¼ í´ë¦­í–ˆì„ ë•Œ typeì— ë”°ë¼ ì¹´í…Œê³ ë¦¬ì˜ ìŠ¤íƒ€ì¼ê³¼ ì§€ë„ì— í‘œì‹œë˜ëŠ” ë§ˆì»¤ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤
        function changeMarker(type) {
            var hospitalMenu = document.getElementById('hospitalMenu');
            var pharmacyMenu = document.getElementById('pharmacyMenu');
            var hairsalonMenu = document.getElementById('hairsalonMenu');

            // ìƒˆë¡œìš´ ë§ˆì»¤ ìœ í˜•ì´ ì„ íƒë  ë•Œ ëª¨ë“  ì¸í¬ìœˆë„ìš°ë¥¼ ë‹«ìŒ  // ì¶”ê°€ëœ ë¶€ë¶„
            if (currentInfowindow) {
                currentInfowindow.close();
                currentInfowindow = null;
                currentMarker = null;
            }

            if (type === 'hospital') {
                hospitalMenu.className = 'menu_selected';
                pharmacyMenu.className = '';
                hairsalonMenu.className = '';

                setHospitalMarkers(map);
                setPharmacyMarkers(null);
                setHairsalonMarkers(null);

            } else if (type === 'pharmacy') {
                hospitalMenu.className = '';
                pharmacyMenu.className = 'menu_selected';
                hairsalonMenu.className = '';

                setHospitalMarkers(null);
                setPharmacyMarkers(map);
                setHairsalonMarkers(null);

            } else if (type === 'hairsalon') {
                hospitalMenu.className = '';
                pharmacyMenu.className = '';
                hairsalonMenu.className = 'menu_selected';

                setHospitalMarkers(null);
                setPharmacyMarkers(null);
                setHairsalonMarkers(map);
            }
        }

        loadMarkers(); // ë§ˆì»¤ë¥¼ ë¡œë“œí•˜ì—¬ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤
    </script>
</div>
</body>
</html>
